name: Smart Notification Manager

on:
  repository_dispatch:
    types: [new_notification]

jobs:
  manage_and_notify:
    runs-on: ubuntu-latest
    steps:
      # --- STEP 1: CHECKOUT ---
      - name: Checkout Code
        uses: actions/checkout@v3

      # --- STEP 2: SETUP NODE ---
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install Firebase Admin
        run: npm install firebase-admin

      # --- STEP 3: ARCHIVE TO PRIVATE REPO ---
      - name: Calculate Repo & Create if Missing
        id: repo_manager
        env:
          GH_TOKEN: ${{ secrets.NOTIFY_ADMIN_TOKEN }} 
          ORG_NAME: "ZaidAlamgir"
        run: |
          CURRENT_YEAR=$(date +%Y)
          BASE_YEAR=2026
          INDEX=$((CURRENT_YEAR - BASE_YEAR + 1))
          if [ $INDEX -lt 1 ]; then INDEX=1; fi
           
          TARGET_REPO="TMP_notify_store${INDEX}"
          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT

          if gh repo view "$ORG_NAME/$TARGET_REPO" > /dev/null 2>&1; then
            echo "✅ Repo $TARGET_REPO exists."
          else
            echo "⚠️ Creating $TARGET_REPO..."
            gh repo create "$ORG_NAME/$TARGET_REPO" --private --description "Notification Storage $CURRENT_YEAR"
            
            git config --global user.email "bot@tmpnews.com"
            git config --global user.name "NotifyBot"
            mkdir temp_init && cd temp_init
            echo "# Notification Storage $CURRENT_YEAR" > README.md
            git init
            git add .
            git commit -m "Initial commit"
            git branch -M main
            git remote add origin "https://$GH_TOKEN@github.com/$ORG_NAME/$TARGET_REPO.git"
            git push -u origin main
            cd .. && rm -rf temp_init
          fi

      - name: Save Data to Target Private Repo
        env:
          API_TOKEN_GITHUB: ${{ secrets.NOTIFY_ADMIN_TOKEN }}
          ORG_NAME: "ZaidAlamgir"
          TARGET_REPO: ${{ steps.repo_manager.outputs.target_repo }}
        run: |
          git clone "https://$API_TOKEN_GITHUB@github.com/$ORG_NAME/$TARGET_REPO.git" private_storage
          cd private_storage
           
          FOLDER_NAME=$(date +%m-%d)
          mkdir -p "notifications/$FOLDER_NAME"
           
          FILENAME="notify_$(date +%s).json"
          echo '${{ toJson(github.event.client_payload) }}' > "notifications/$FOLDER_NAME/$FILENAME"
           
          git config --global user.email "bot@tmpnews.com"
          git config --global user.name "NotifyBot"
          git add .
          git commit -m "New Notification: ${{ github.event.client_payload.headline }}"
          git push origin main

      # --- ⏳ NEW STEP: WAIT FOR DEPLOYMENT (60 Seconds) ---
      # This pauses the workflow to ensure the article is live before notifying users.
      - name: ⏳ Wait for 60 Seconds (Deployment Buffer)
        run: sleep 60

      # --- STEP 4: SEND NOTIFICATION ---
      - name: Send Notification via FCM
        uses: actions/github-script@v6
        env:
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        with:
          script: |
            const admin = require('firebase-admin');
            
            // 1. Safe JSON Parsing
            const rawCreds = process.env.FIREBASE_CREDENTIALS;
            if (!rawCreds) {
              core.setFailed("❌ ERROR: Secret FIREBASE_SERVICE_ACCOUNT is missing.");
              return;
            }

            let serviceAccount;
            try {
              serviceAccount = JSON.parse(rawCreds);
            } catch (e) {
              core.setFailed(`❌ ERROR: JSON Parse failed: ${e.message}`);
              return;
            }

            // 2. Initialize Firebase
            if (!admin.apps.length) {
              admin.initializeApp({
                credential: admin.credential.cert(serviceAccount)
              });
            }

            // Get Payload
            const payload = context.payload.client_payload;
            
            // Construct Message
            const message = {
              topic: 'news_alerts',
              data: {
                title: payload.headline,
                body: payload.subheadline || "Tap to read more",
                image: payload.image_url || "",
                author: payload.author || "TMP News",
                date: payload.date || new Date().toISOString(),
                type: "standard", 
                link: payload.link || "tmp://home" 
              },
              android: {
                priority: 'high',
                ttl: 86400000
              }
            };

            console.log("Sending FCM Message...");

            try {
              const response = await admin.messaging().send(message);
              console.log('✅ Successfully sent message:', response);
            } catch (error) {
              console.error('❌ Error sending message:', error);
              core.setFailed(error.message);
            }
