name: Smart Notification Manager

on:
  repository_dispatch:
    types: [new_notification]

jobs:
  manage_and_notify:
    runs-on: ubuntu-latest
    steps:
      # --- STEP 1: CHECKOUT ---
      - name: Checkout Code
        uses: actions/checkout@v3

      # --- STEP 2: SETUP NODE (Required for safe JSON handling) ---
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install Firebase Admin
        run: npm install firebase-admin

      # --- STEP 3: ARCHIVE TO PRIVATE REPO (Your Custom Logic) ---
      - name: Calculate Repo & Create if Missing
        id: repo_manager
        env:
          GH_TOKEN: ${{ secrets.NOTIFY_ADMIN_TOKEN }} 
          ORG_NAME: "ZaidAlamgir"
        run: |
          # 1. Calculate Index based on Year
          CURRENT_YEAR=$(date +%Y)
          BASE_YEAR=2026
          INDEX=$((CURRENT_YEAR - BASE_YEAR + 1))
          if [ $INDEX -lt 1 ]; then INDEX=1; fi
          
          TARGET_REPO="TMP_notify_store${INDEX}"
          echo "Target Repo: $TARGET_REPO"
          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT

          # 2. Check/Create Repo
          if gh repo view "$ORG_NAME/$TARGET_REPO" > /dev/null 2>&1; then
            echo "✅ Repo $TARGET_REPO already exists."
          else
            echo "⚠️ Repo $TARGET_REPO does not exist. Creating now..."
            gh repo create "$ORG_NAME/$TARGET_REPO" --private --description "Notification Storage $CURRENT_YEAR"
            
            # Initialize repo
            git config --global user.email "bot@tmpnews.com"
            git config --global user.name "NotifyBot"
            mkdir temp_init && cd temp_init
            echo "# Notification Storage $CURRENT_YEAR" > README.md
            git init
            git add .
            git commit -m "Initial commit"
            git branch -M main
            git remote add origin "https://$GH_TOKEN@github.com/$ORG_NAME/$TARGET_REPO.git"
            git push -u origin main
            cd .. && rm -rf temp_init
            echo "✅ Created and initialized $TARGET_REPO"
          fi

      - name: Save Data to Target Private Repo
        env:
          API_TOKEN_GITHUB: ${{ secrets.NOTIFY_ADMIN_TOKEN }}
          ORG_NAME: "ZaidAlamgir"
          TARGET_REPO: ${{ steps.repo_manager.outputs.target_repo }}
        run: |
          git clone "https://$API_TOKEN_GITHUB@github.com/$ORG_NAME/$TARGET_REPO.git" private_storage
          cd private_storage
          
          FOLDER_NAME=$(date +%m-%d)
          mkdir -p "notifications/$FOLDER_NAME"
          
          FILENAME="notify_$(date +%s).json"
          echo '${{ toJson(github.event.client_payload) }}' > "notifications/$FOLDER_NAME/$FILENAME"
          
          git config --global user.email "bot@tmpnews.com"
          git config --global user.name "NotifyBot"
          git add .
          git commit -m "New Notification: ${{ github.event.client_payload.headline }}"
          git push origin main

      # --- STEP 4: SEND NOTIFICATION (Safe Node.js Version) ---
      - name: Send Notification via FCM
        uses: actions/github-script@v6
        env:
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_TMP_APP_380A9 }}
        with:
          script: |
            const admin = require('firebase-admin');
            
            // Initialize Firebase
            const serviceAccount = JSON.parse(process.env.FIREBASE_CREDENTIALS);
            if (!admin.apps.length) {
              admin.initializeApp({
                credential: admin.credential.cert(serviceAccount)
              });
            }

            // Get Payload
            const payload = context.payload.client_payload;
            
            // Construct Message (Safe from Quote Crashes)
            const message = {
              topic: 'news_alerts',
              data: {
                title: payload.headline,
                body: payload.subheadline || "Tap to read more",
                image: payload.image_url || "",
                author: payload.author || "TMP News",
                date: payload.date || new Date().toISOString(),
                type: "standard", 
                link: payload.link || "tmp://home" // Fallback if link is missing
              },
              android: {
                priority: 'high',  // Wake up device
                ttl: 86400000      // 24 Hours (in Milliseconds for Node SDK)
              }
            };

            console.log("Sending FCM Message...");

            try {
              const response = await admin.messaging().send(message);
              console.log('✅ Successfully sent message:', response);
            } catch (error) {
              console.error('❌ Error sending message:', error);
              core.setFailed(error.message);
            }
